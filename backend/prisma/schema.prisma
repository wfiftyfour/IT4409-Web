generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")

}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  workspaceMembers WorkspaceMember[]
  channelMembers   ChannelMember[]
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  username      String   @unique
  password      String
  fullName      String
  gender        String
  dateOfBirth   DateTime
  avatarUrl     String?
  refreshToken  String?       
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  presence      UserPresence?
  workspaceMembers WorkspaceMember[]
  channelMembers   ChannelMember[]
  channelJoinRequestsSent ChannelJoinRequest[] @relation("ChannelJoinRequestUser")
  channelJoinRequestsReviewed ChannelJoinRequest[] @relation("ChannelJoinRequestReviewer")
  workspaceJoinRequestSent WorkspaceJoinRequest[] @relation("WorkspaceJoinRequestUser")
  workspaceJoinRequestReviewed WorkspaceJoinRequest[] @relation("WorkspaceJoinRequestReviewer")
  conversations    ConversationParticipant[]
  messagesSent     Message[]       @relation("SenderMessages")
  messagesDeleted  Message[]       @relation("DeletedMessages")
  messageMentions  MessageMention[]
  notifications    Notification[]
  posts            Post[]
  comments         Comment[]
  reactions        Reaction[]
  filesUploaded    File[]
  otps             Otp[]
}


model UserPresence {
  userId    String   @id
  status    String   @default("offline")
  lastSeen  DateTime?
  updatedAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Workspace {
  id          String            @id @default(uuid())
  name        String
  description String?
  avatarUrl   String?
  isPrivate   Boolean           @default(false)
  joinCode    String?           @unique    
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  members     WorkspaceMember[]
  channels    Channel[]
  joinRequests WorkspaceJoinRequest[]

}

model WorkspaceMember {
  id          String    @id @default(uuid())
  workspaceId String
  userId      String
  roleId        String
  joinedAt    DateTime  @default(now())

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        Role      @relation(fields: [roleId], references: [id])

  @@unique([workspaceId, userId])
}

model WorkspaceJoinRequest {
  id         String    @id @default(uuid())
  workspaceId  String
  userId     String
  status     String    @default("PENDING")
  createdAt  DateTime  @default(now())
  reviewedAt DateTime?
  reviewedBy String?

  workspace    Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user       User      @relation("WorkspaceJoinRequestUser", fields: [userId], references: [id], onDelete: Cascade)
  
  // Relation với người review
  reviewer   User?     @relation("WorkspaceJoinRequestReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([workspaceId, userId, status])
  @@index([status])
}


model Channel {
  id          String           @id @default(uuid())
  workspaceId String
  name        String
  description String?
  isPrivate   Boolean          @default(false)
  joinCode    String?          @unique
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  workspace   Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  members     ChannelMember[]
  joinRequests ChannelJoinRequest[]
  conversations Conversation[]
  posts       Post[]
  files       File[]

  @@index([workspaceId])
}

model ChannelMember {
  id        String   @id @default(uuid())
  channelId String
  userId    String
  roleId      String
  joinedAt  DateTime @default(now())

  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        Role      @relation(fields: [roleId], references: [id])

  @@unique([channelId, userId])
}

model ChannelJoinRequest {
  id         String    @id @default(uuid())
  channelId  String
  userId     String
  status     String    @default("PENDING")
  createdAt  DateTime  @default(now())
  reviewedAt DateTime?
  reviewedBy String?

  channel    Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user       User      @relation("ChannelJoinRequestUser", fields: [userId], references: [id], onDelete: Cascade)
  
  // Relation với người review
  reviewer   User?     @relation("ChannelJoinRequestReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([channelId, userId, status])
  @@index([status])
}

model Conversation {
  id         String    @id @default(uuid())
  type       String
  channelId  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  channel    Channel?  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  participants ConversationParticipant[]
  messages     Message[]

  @@index([type])
  @@index([channelId])
}

model ConversationParticipant {
  id             String    @id @default(uuid())
  conversationId String
  userId         String
  joinedAt       DateTime  @default(now())
  lastReadAt     DateTime?

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model Reactable {
  id   String  @id @default(uuid())
  type String
  posts    Post[]
  messages Message[]
  comments Comment[]
  reactions Reaction[]
  fileAttachments FileAttachment[]
}

model Message {
  id            String    @id @default(uuid())
  conversationId String
  senderId      String
  content       String?
  replyToId     String?
  isDeleted     Boolean   @default(false)
  deletedAt     DateTime?
  deletedById   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  reactableId   String    @unique

  conversation  Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender        User         @relation("SenderMessages", fields: [senderId], references: [id], onDelete: Cascade)
  deletedBy     User?        @relation("DeletedMessages", fields: [deletedById], references: [id], onDelete: SetNull)
  replyTo       Message?     @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  mentions      MessageMention[]
  reactable     Reactable    @relation(fields: [reactableId], references: [id], onDelete: Cascade)

  replies       Message[]    @relation("MessageReplies")
}

model MessageMention {
  id             String    @id @default(uuid())
  messageId      String
  mentionedUserId String
  createdAt      DateTime  @default(now())

  message        Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  mentionedUser  User      @relation(fields: [mentionedUserId], references: [id], onDelete: Cascade)
}

model Notification {
  id          String   @id @default(uuid())
  userId      String
  type        String
  content     String
  referenceId String?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}

model Post {
  id          String   @id @default(uuid())
  channelId   String
  authorId    String
  content     String
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  reactableId String   @unique

  channel     Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments    Comment[]
  reactable   Reactable @relation(fields: [reactableId], references: [id], onDelete: Cascade)

  @@index([channelId, createdAt])
  @@index([authorId])
}

model Comment {
  id          String   @id @default(uuid())
  postId      String
  authorId    String
  content     String
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  reactableId String   @unique

  post        Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  reactable   Reactable @relation(fields: [reactableId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt])
  @@index([authorId])
}

model Reaction {
  id          String   @id @default(uuid())
  reactableId String
  userId      String
  emoji       String
  createdAt   DateTime @default(now())

  reactable   Reactable @relation(fields: [reactableId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reactableId, userId, emoji])
  @@index([userId])
}

model File {
  id         String   @id @default(uuid())
  channelId  String
  uploadedBy String
  fileName   String
  fileUrl    String
  createdAt  DateTime @default(now())

  channel    Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  uploader   User    @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([uploadedBy])
  @@index([createdAt])
}

model FileAttachment {
  id          String    @id @default(uuid())
  reactableId String
  fileUrl     String
  createdAt   DateTime  @default(now())

  reactable   Reactable @relation(fields: [reactableId], references: [id], onDelete: Cascade)

  @@index([reactableId])
}

model Otp {
  id         String   @id @default(uuid())
  userId     String
  otpCode    String
  expiresAt  DateTime
  isUsed     Boolean  @default(false)
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
  @@index([otpCode, isUsed])
}

